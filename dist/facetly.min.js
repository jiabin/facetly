/*! Facetly - v0.1.0 - 2013-09-23
* https://github.com/jiabin/facetly
* Copyright (c) 2013 Eymen Gunay; Licensed MIT */

var Facetly=Facetly||function($){var Utils={},Ajax={},Events={},Templates={},UI={},Query={},App={},Public={};Utils={settings:{debug:!0,selector:"#facetly",elasticsearch:"http://localhost:9200",perPage:25,currentPage:1,excludedFields:[],meta:{},onSerialize:function(){},init:function(e){_log("Initializing Settings"),$('meta[name^="facetly-"]').each(function(){Utils.settings.meta[this.name.replace("facetly-","")]=this.content}),Utils.settings=Utils.extend(Utils.settings,e),element=$(Utils.settings.selector),_log("Initialized Settings")}},cache:{window:window,document:document},extend:function(e,t){return $.extend(e,t)},merge:function(e,t){return $.merge(e,t)},elastic_url:function(){return Utils.settings.elasticsearch},elastic_search_url:function(){return Utils.elastic_url()},log:function(e){Utils.settings.debug&&console.log(e)},parseRoute:function(e){var t=e.delimiter||"/",a=e.path.split(t),i=e.target[a.shift()],s=i!==void 0,n=0==a.length;e.inits=e.inits||[],s?("function"==typeof i.init&&e.inits.push(i.init),n?e.parsed.call(void 0,{exists:!0,type:typeof i,obj:i,inits:e.inits}):Utils.parseRoute({path:a.join(t),target:i,delimiter:t,parsed:e.parsed,inits:e.inits})):e.parsed.call(void 0,{exists:!1})},route:function(){Utils.parseRoute({path:Utils.settings.meta.route,target:Routes,delimiter:"/",parsed:function(e){if(e.exists&&"function"==e.type){if(0!=e.inits.length)for(var t in e.inits)e.inits[t].call();e.obj.call()}}})},clone:[]};var _log=Utils.log;Ajax={send:function(e,t,a,i){$.ajax({type:e,url:t,dataType:"json",data:a,success:i})},call:function(e,t,a){Ajax.send("POST",e,t,a)},get:function(e,t,a){Ajax.send("GET",e,t,a)},facets:!1},Events={endpoints:{serializeDateHistogram:function(){var e=$(this).attr("data-name");Query.holder[e]={};var t=$(this).val();if(t){var a=t.split(",");if(2==a.length){var i=Ajax.facets[e].entries;a[0]=void 0==i[a[0]]||void 0==i[a[0]].time?i[0].time:i[a[0]].time,a[1]=void 0==i[a[1]]||void 0==i[a[1]].time?i[i.length-1].time:i[a[1]].time;var s=$("#facetly-form ul#facet-"+e+" :input").serializeObject(),n=0;for(q in s[e]){var l=s[e][q].operator;if(""!=l&&""!=a[0]&&""!=a[1]){void 0==Query.holder[e][l]&&(Query.holder[e][l]=[]);var r={};r.range={},r.range[e]={from:parseInt(a[0]),to:parseInt(a[1])},Query.holder[e][l].push(r),n++}}App.loadResults()}}},serializeTerms:function(){var e=$(this).attr("data-name"),t=$("#facetly-form ul#facet-"+e+" :input").serializeObject();Query.holder[e]={};var a=0;for(q in t[e]){var i=t[e][q].operator,s=t[e][q].value;if(""!=i&&""!=s){void 0==Query.holder[e][i]&&(Query.holder[e][i]=[]);var n={match_phrase:{}};n.match_phrase[e]=s,Query.holder[e][i].push(n),a++}}App.loadResults()},serializeNested:function(){var e=$(this).attr("data-name"),t=$("#facetly-form ul#facet-"+e+" :input").serializeObject(),a=Utils.settings.facets[e].nested,i=Utils.settings.facets[e].terms.field?Utils.settings.facets[e].terms.field:Utils.settings.facets[e].terms.script_field;Query.holder[e]={};var s=0;for(q in t[e]){var n=t[e][q].operator,l=t[e][q].value;if(""!=t[e][q].operator&&""!=t[e][q].value){void 0==Query.holder[e][t[e][q].operator]&&(Query.holder[e][t[e][q].operator]=[]);var r={nested:{path:a,query:{match_phrase:{}}}};r.nested.query.match_phrase[i]=l,Query.holder[e][n].push(r),s++}}App.loadResults()},clone:function(e){var li=$(this).closest("li"),name=$(this).attr("data-name"),cloneables=$("li[data-clonable='facetly-"+name+"']"),firstLi=cloneables.first(),firstLiHTML=firstLi[0].outerHTML;void 0==Utils.clone[name]&&(Utils.clone[name]=cloneables.length),Utils.clone[name]=Utils.clone[name]+1;var index=eval("("+decodeURIComponent($(this).attr("data-index"))+")");for(i in index){var pattern=RegExp(RegExp.quote(index[i].orig),"g");firstLiHTML=firstLiHTML.replace(pattern,index[i].format.replace("{#}",Utils.clone[name]))}var pattern=RegExp(RegExp.quote('data-bound="true"'),"g");firstLiHTML=firstLiHTML.replace(pattern,""),$(firstLi).after(firstLiHTML),Events.bindEvents()},remove:function(){var e=$(this).closest("li"),t=$(e).parent();return 1==$("li.custom",t).length?!1:($(e).remove(),Events.bindEvents(),void 0)}},serialize:function(){var e={bool:{}};e.bool.must=[],e.bool.should=[],e.bool.must_not=[];var t=0;for(i in Query.holder)for(ii in Query.holder[i])for(iii in Query.holder[i][ii])e.bool[ii].push(Query.holder[i][ii][iii]),t++;var e=0==t?Query.matchAllQuery():e;Query.currentQuery=e;var a={query:e,size:Utils.settings.perPage},s=Query.create(e);return Utils.settings.onSerialize&&Utils.settings.onSerialize(a,s),a},bindEvents:function(){_log("Binding Events"),$("[data-event]").each(function(){var e=this,t=e.dataset.method||"click",a=e.dataset.event,i=e.dataset.bound;i||Utils.parseRoute({path:a,target:Events.endpoints,delimiter:".",parsed:function(a){a.exists&&(e.dataset.bound=!0,$(e).on(t,function(t){a.obj.call(e,t)}))}})}),_log("Events Bound")},init:function(){Events.bindEvents()}},Templates={init:function(){_log("Compiling templates"),Templates.types.terms=Handlebars.compile(Templates.types.terms),Templates.types.nested=Handlebars.compile(Templates.types.nested),Templates.types.date_histogram=Handlebars.compile(Templates.types.date_histogram),Handlebars.registerHelper("random",function(){var e=String.fromCharCode(65+Math.floor(26*Math.random())),t=e+Date.now();return t}),Handlebars.registerHelper("unique_inc",function(){return val+1}),Handlebars.registerHelper("inc",function(e){return e+1}),Handlebars.registerHelper("type",function(e,t){var a=Templates.types[e._type];return void 0!=Utils.settings.facets[t].nested&&(a=Templates.types.nested),new Handlebars.SafeString(a({facet:e,name:t}))}),Handlebars.registerHelper("facets",function(e,t){return t.fn(Utils.settings.facets[e])}),Handlebars.registerHelper("thead",function(e){var t="<tr>";for(i in e.hits.hits){for(key in e.hits.hits[i]._source)t+="<th>"+key+"</th>";break}return t+="</tr>",new Handlebars.SafeString(t)}),Handlebars.registerHelper("json",function(e){return"object"==typeof e?JSON.stringify(e):e}),Templates.facets=Handlebars.compile(Templates.facets),Templates.results=Handlebars.compile(Templates.results),_log("Templates Compiled")},types:{nested:'<ul id="facet-{{name}}">                 <li class="custom" data-clonable="facetly-{{name}}">                     <div class="form-inline">                         <select class="input-small" name="{{name}}[0][operator]" data-type="operator" data-name="{{name}}" data-event="serializeNested" data-method="change">                             <option value=""></option>                             <option value="must">Must</option>                             <option value="should">Should</option>                             <option value="must_not">Must Not</option>                         </select>                         <div class="input-append">                             <input class="input-medium" name="{{name}}[0][value]" type="text" data-name="{{name}}" data-type="value" data-event="serializeNested" data-method="keyup">                             <a href="javascript:void()" class="add-on" data-event="clone"  data-index="%5B%7Borig%3A%20%27{{name}}%5B0%5D%5Boperator%5D%27%2C%20format%3A%20%27{{name}}%5B%7B%23%7D%5D%5Boperator%5D%27%7D%2C%20%7Borig%3A%20%27{{name}}%5B0%5D%5Bvalue%5D%27%2C%20format%3A%20%27{{name}}%5B%7B%23%7D%5D%5Bvalue%5D%27%7D%5D" data-name="{{name}}" data-method="click"><i class="icon-plus"></i></a>                             <a href="javascript:void()" class="add-on" data-event="remove" data-name="{{name}}" data-method="click"><i class="icon-trash"></i></a>                         </div>                     </div>                 </li>                 {{#each facet.terms}}                     <li data-clonable="facetly-{{../name}}">                         <div class="form-inline">                             <select class="input-small" name="{{../name}}[{{inc @index}}][operator]" data-name="{{../name}}" data-event="serializeNested" data-method="change">                                 <option value=""></option>                                 <option value="must">Must</option>                                 <option value="should">Should</option>                                 <option value="must_not">Must Not</option>                             </select>                             <input class="input-medium" type="text" value="{{this.term}}" name="{{../name}}[{{inc @index}}][value]" readonly="readonly" data-event="serializeNested" data-method="keyup">                             <small>({{this.count}})</small>                         </div>                     </li>                 {{/each}}             </ul>',terms:'<ul id="facet-{{name}}">                 <li class="custom" data-clonable="facetly-{{name}}">                     <div class="form-inline">                         <select class="input-small" name="{{name}}[0][operator]" data-type="operator" data-name="{{name}}" data-event="serializeTerms" data-method="change">                             <option value=""></option>                             <option value="must">Must</option>                             <option value="should">Should</option>                             <option value="must_not">Must Not</option>                         </select>                         <div class="input-append">                             <input class="input-medium" name="{{name}}[0][value]" type="text" data-name="{{name}}" data-type="value" data-event="serializeTerms" data-method="keyup">                             <a href="javascript:void()" class="add-on" data-event="clone" data-index="%5B%7Borig%3A%20%27{{name}}%5B0%5D%5Boperator%5D%27%2C%20format%3A%20%27{{name}}%5B%7B%23%7D%5D%5Boperator%5D%27%7D%2C%20%7Borig%3A%20%27{{name}}%5B0%5D%5Bvalue%5D%27%2C%20format%3A%20%27{{name}}%5B%7B%23%7D%5D%5Bvalue%5D%27%7D%5D" data-name="{{name}}" data-method="click"><i class="icon-plus"></i></a>                             <a href="javascript:void()" class="add-on" data-event="remove" data-name="{{name}}" data-method="click"><i class="icon-trash"></i></a>                         </div>                     </div>                 </li>                 {{#each facet.terms}}                     <li data-clonable="facetly-{{../name}}">                         <div class="form-inline">                             <select class="input-small" name="{{../name}}[{{inc @index}}][operator]" data-name="{{../name}}" data-event="serializeTerms" data-method="change">                                 <option value=""></option>                                 <option value="must">Must</option>                                 <option value="should">Should</option>                                 <option value="must_not">Must Not</option>                             </select>                             <input class="input-medium" type="text" value="{{this.term}}" name="{{../name}}[{{inc @index}}][value]" readonly="readonly" data-event="serializeTerms" data-method="keyup">                             <small>({{this.count}})</small>                         </div>                     </li>                 {{/each}}             </ul>',date_histogram:'<ul id="facet-{{name}}">                 <li class="custom" data-clonable="facetly-{{name}}">                     <div id="facetly-slider-graph-{{name}}-0"></div>                     <div class="form-inline">                         <select class="input-small" name="{{name}}[0][operator]" data-type="operator" data-name="{{name}}" data-event="serializeDateHistogram" data-method="change">                             <option value=""></option>                             <option value="must">Must</option>                             <option value="should">Should</option>                             <option value="must_not">Must Not</option>                         </select>                         <div class="slide-wrapper">                             <input type="text" class="input-medium" name="{{name}}[0][value]" data-name="{{name}}" id="facetly-slider-{{name}}-0" value="" data-slider-min="0" data-slider-max="{{facet.entries.length}}" data-slider-step="1" data-slider-value="[0, {{facet.entries.length}}]" data-slider-selection="after" data-slider-tooltip="hide" data-event="serializeDateHistogram" method="change">                         </div>                         <!-- <div class="btn-group">                             <a href="javascript:void()" class="btn btn-mini" data-src="facetly-clonable-{{name}}" data-index="alert(\'TODO\')" data-event="clone" data-name="{{name}}" data-method="click"><i class="icon-plus"></i></a>                             <a href="javascript:void()" class="btn btn-mini" data-event="remove" data-name="{{name}}" data-method="click"><i class="icon-trash"></i></a>                         </div> -->                     </div>                     <script>                     var values = new Array();                     {{#each facet.entries}}                     values.push({                         time: {{this.time}},                         count: {{this.count}}                     });                     {{/each}}                     $("#facetly-slider-{{name}}-0").slider().on("slideStop", function(ev){                         $("#facetly-slider-{{name}}-0").trigger("click", [{}]);                     });                     </script>                 </li>             </ul>'},results:'<div class="box-scrollable">             <table class="table table-striped table-bordered">                 <thead>                     {{thead results}}                 </thead>                 <tbody>                     {{#each results.hits.hits}}                     <tr>                         {{#each this._source}}                             <td>{{json this}}</td>                         {{/each}}                     </tr>                     {{else}}                     <tr>                         <td>No results found</td>                     </tr>                     {{/each}}                 </tbody>             </table>         </div>         <p>{{results.hits.total}} results found</p>',facets:'<form id="facetly-form">             <ul>                 {{#each facets}}                     <li>                         <div class="header">                             {{@key}}                             {{#if this.total}}                             <small>Total: {{this.total}}</small>                             {{/if}}                             {{#if this.entries}}                             <small>Total: {{this.entries.length}}</small>                             {{/if}}                             {{#if this.other}}                             <small>Other: {{this.other}}</small>                             {{/if}}                         </div>                         <div class="content">                             {{type this @key}}                         </div>                     </li>                 {{/each}}             </ul>         </form>         <script>         $( "'+Utils.settings.selector+' ul" ).accordion({             header: "> li > .header",             heightStyle: "content"         });         </script>'},UI={init:function(){UI.container=Handlebars.compile(UI.container),UI.container=$(UI.container()),UI.sidebar=Handlebars.compile(UI.sidebar),UI.sidebar=$(UI.sidebar()),UI.results=Handlebars.compile(UI.results),UI.results=$(UI.results()),element.append(UI.container),UI.container.append(UI.sidebar),UI.container.append(UI.results)},container:'<div class="row-fluid"></div>',sidebar:'<div class="sidebar span4"></div>',results:'<div class="results span8"></div>'},Query={create:function(e){return JSON.stringify(e)},matchAllQuery:function(){var e={};return e.match_all={},e},holder:{},currentQuery:{}},App={logic:{},init:function(e){_log("Initializing Facetly"),Utils.settings.init(e),UI.init(),Templates.init(),_log("Initialized Facetly"),Utils.cache.window.tmp={},App.loadFacets(function(){Events.init()}),App.loadResults(function(){Events.init()})},loadFacets:function(e){_log("Getting Facets"),Ajax.call(Utils.elastic_search_url(),Query.create({facets:Utils.settings.facets,query:Query.matchAllQuery}),function(t){UI.sidebar.html(Templates.facets({facets:t.facets})),Ajax.facets=t.facets,_log("Facets Loaded"),e&&e()})},loadResults:function(e){_log("Loading Results"),Ajax.call(Utils.elastic_search_url(),Query.create(Events.serialize()),function(t){UI.results.html(Templates.results({results:t})),_log("Results Loaded"),e&&e()})}};var element;return Public={init:function(e){App.init(e)},loadFacets:App.loadFacets,templates:App.Templates,currentQuery:Query.currentQuery}}(window.jQuery);RegExp.quote=function(e){return(e+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")},function(e){e.fn.serializeObject=function(){var t=this,a={},i={},s={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/};return this.build=function(e,t,a){return e[t]=a,e},this.push_counter=function(e){return void 0===i[e]&&(i[e]=0),i[e]++},e.each(e(this).serializeArray(),function(){if(s.validate.test(this.name)){for(var i,n=this.name.match(s.key),l=this.value,r=this.name;void 0!==(i=n.pop());)r=r.replace(RegExp("\\["+i+"\\]$"),""),i.match(s.push)?l=t.build([],t.push_counter(r),l):i.match(s.fixed)?l=t.build([],i,l):i.match(s.named)&&(l=t.build({},i,l));a=e.extend(!0,a,l)}}),a}}(jQuery);