<!DOCTYPE html>  <html> <head>   <title>search_box.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="search_facets.html">                 search_facets.js               </a>                                           <a class="source" href="search_query.html">                 search_query.js               </a>                                           <a class="source" href="templates.html">                 templates.js               </a>                                           <a class="source" href="backbone_extensions.html">                 backbone_extensions.js               </a>                                           <a class="source" href="hotkeys.html">                 hotkeys.js               </a>                                           <a class="source" href="inflector.html">                 inflector.js               </a>                                           <a class="source" href="jquery_extensions.html">                 jquery_extensions.js               </a>                                           <a class="source" href="search_parser.html">                 search_parser.js               </a>                                           <a class="source" href="search_box.html">                 search_box.js               </a>                                           <a class="source" href="search_facet.html">                 search_facet.js               </a>                                           <a class="source" href="search_input.html">                 search_input.js               </a>                                           <a class="source" href="visualsearch.html">                 visualsearch.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               search_box.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

<span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">;</span> <span class="c1">// Handle namespaced jQuery</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The search box is responsible for managing the many facet views and input views.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">VS</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">SearchBox</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

  <span class="nx">id</span>  <span class="o">:</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span>

  <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click .VS-cancel-search-box&#39;</span> <span class="o">:</span> <span class="s1">&#39;clearSearch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mousedown .VS-search-box&#39;</span>    <span class="o">:</span> <span class="s1">&#39;maybeFocusSearch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dblclick .VS-search-box&#39;</span>     <span class="o">:</span> <span class="s1">&#39;highlightSearch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .VS-search-box&#39;</span>        <span class="o">:</span> <span class="s1">&#39;maybeTripleClick&#39;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Creating a new SearchBox registers handlers for re-rendering facets when necessary,
as well as handling typing when a facet is selected.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flags</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">allSelected</span> <span class="o">:</span> <span class="kc">false</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;renderFacets&#39;</span><span class="p">,</span> <span class="s1">&#39;_maybeDisableFacets&#39;</span><span class="p">,</span> <span class="s1">&#39;disableFacets&#39;</span><span class="p">,</span>
              <span class="s1">&#39;deselectAllFacets&#39;</span><span class="p">,</span> <span class="s1">&#39;addedFacet&#39;</span><span class="p">,</span> <span class="s1">&#39;removedFacet&#39;</span><span class="p">,</span> <span class="s1">&#39;changedFacet&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">searchQuery</span>
            <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderFacets</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addedFacet</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">removedFacet</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">changedFacet</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_maybeDisableFacets</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Renders the search box, but requires placement on the page through <code>this.el</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">JST</span><span class="p">[</span><span class="s1">&#39;search_box&#39;</span><span class="p">]({}));</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">setMode</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>Querying Facets</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Either gets a serialized query string or sets the faceted query from a query string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">value</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">query</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Uses the VS.app.searchQuery collection to serialize the current query from the various
facets that are in the search box.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">serialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">query</span>           <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">inputViewsCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">searchQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">facet</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">());</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">facet</span><span class="p">.</span><span class="nx">serialize</span><span class="p">());</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">inputViewsCount</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="nx">inputViewsCount</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">compact</span><span class="p">(</span><span class="nx">query</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Returns any facet views that are currently selected. Useful for changing the value
callbacks based on what else is in the search box and which facet is being edited.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">selected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">editing</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span> <span class="o">||</span> <span class="nx">view</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">selected</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Similar to <code>this.selected</code>, returns any facet models that are currently selected.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">selectedModels</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">(),</span> <span class="s1">&#39;model&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Takes a query string and uses the SearchParser to parse and render it. Note that
<code>VS.app.SearchParser</code> refreshes the <code>VS.app.searchQuery</code> collection, which is bound
here to call <code>this.renderFacets</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">setQuery</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentQuery</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span>
    <span class="nx">VS</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">SearchParser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span> <span class="nx">query</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Returns the position of a facet/input view. Useful when moving between facets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">viewPosition</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">views</span>    <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;facet&#39;</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">views</span><span class="p">,</span> <span class="nx">view</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">position</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Used to launch a search. Hitting enter or clicking the search button.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">searchEvent</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">focusSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">searchQuery</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>Rendering Facets</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Add a new facet. Facet will be focused and ready to accept a value. Can also
specify position, in the case of adding facets from an inbetween input.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">addFacet</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">category</span><span class="p">,</span> <span class="nx">initialQuery</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">category</span>     <span class="o">=</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">inflector</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">category</span><span class="p">);</span>
    <span class="nx">initialQuery</span> <span class="o">=</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">inflector</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">initialQuery</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">category</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">SearchFacet</span><span class="p">({</span>
      <span class="nx">category</span> <span class="o">:</span> <span class="nx">category</span><span class="p">,</span>
      <span class="nx">value</span>    <span class="o">:</span> <span class="nx">initialQuery</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="nx">app</span>      <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">app</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">searchQuery</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="p">{</span><span class="nx">at</span><span class="o">:</span> <span class="nx">position</span><span class="p">});</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Renders a newly added facet, and selects it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">addedFacet</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">renderFacets</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">facetView</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">model</span> <span class="o">==</span> <span class="nx">model</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">facetView</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Changing a facet programmatically re-renders it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">changedFacet</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">renderFacets</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>When removing a facet, potentially do something. For now, the adjacent
remaining facet is selected, but this is handled by the facet's view,
since its position is unknown by the time the collection triggers this
remove callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">removedFacet</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">facet</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Renders each facet as a searchFacet view.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">renderFacets</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-search-inner&#39;</span><span class="p">).</span><span class="nx">empty</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">searchQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">renderFacet</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Add on an n+1 empty search input on the very end.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">renderSearchInput</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">renderPlaceholder</span><span class="p">();</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Render a single facet, using its category and query value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">renderFacet</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">facet</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">SearchFacet</span><span class="p">({</span>
      <span class="nx">app</span>   <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span>
      <span class="nx">model</span> <span class="o">:</span> <span class="nx">facet</span><span class="p">,</span>
      <span class="nx">order</span> <span class="o">:</span> <span class="nx">position</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Input first, facet second.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">renderSearchInput</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-search-inner&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">eq</span><span class="p">(</span><span class="nx">position</span><span class="o">*</span><span class="mi">2</span><span class="p">).</span><span class="nx">after</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>

    <span class="nx">view</span><span class="p">.</span><span class="nx">calculateSize</span><span class="p">();</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">calculateSize</span><span class="p">,</span> <span class="nx">view</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">view</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Render a single input, used to create and autocomplete facets</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">renderSearchInput</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">SearchInput</span><span class="p">({</span>
      <span class="nx">position</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> 
      <span class="nx">app</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span>
      <span class="nx">showFacets</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">showFacets</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-search-inner&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
  <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Handles showing/hiding the placeholder text</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">renderPlaceholder</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$placeholder</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-placeholder&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">searchQuery</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$placeholder</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;VS-hidden&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">$placeholder</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;VS-hidden&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">placeholder</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h1>Modifying Facets</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Clears out the search box. Command+A + delete can trigger this, as can a cancel button.</p>

<p>If a <code>clearSearch</code> callback was provided, the callback is invoked and
provided with a function performs the actual removal of the data.  This
allows third-party developers to either clear data asynchronously, or
prior to performing their custom "clear" logic.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">clearSearch</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">actualClearSearch</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">disableFacets</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">searchEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">focusSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">clearSearch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">clearSearch</span><span class="p">(</span><span class="nx">actualClearSearch</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">actualClearSearch</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Command+A selects all facets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">selectAllFacets</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">one</span><span class="p">(</span><span class="s1">&#39;click.selectAllFacets&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">deselectAllFacets</span><span class="p">);</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">facetView</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">facetView</span><span class="p">.</span><span class="nx">selectFacet</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">inputView</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">inputView</span><span class="p">.</span><span class="nx">selectText</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Used by facets and input to see if all facets are currently selected.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">allSelected</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">deselect</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">deselect</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span><span class="p">;</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>After <code>selectAllFacets</code> is engaged, this method is bound to the entire document.
This immediate disables and deselects all facets, but it also checks if the user
has clicked on either a facet or an input, and properly selects the view.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">deselectAllFacets</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">disableFacets</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;.category,input&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">el</span>   <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;.search_facet,.search_input&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">v</span><span class="p">.</span><span class="nx">el</span> <span class="o">==</span> <span class="nx">el</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;facet&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">selectFacet</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Disables all facets except for the passed in view. Used when switching between
facets, so as not to have to keep state of active facets.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">disableFacets</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">keepView</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span> <span class="o">!=</span> <span class="nx">keepView</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">editing</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span> <span class="o">||</span> <span class="nx">view</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">selected</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">disableEdit</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span> <span class="o">!=</span> <span class="nx">keepView</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">editing</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span> <span class="o">||</span> <span class="nx">view</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">selected</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">disableEdit</span><span class="p">();</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">deselectFacet</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">removeFocus</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;click.selectAllFacets&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Resize all inputs to account for extra keystrokes which may be changing the facet
width incorrectly. This is a safety check to ensure inputs are correctly sized.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">resizeFacets</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">facetView</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">view</span> <span class="o">||</span> <span class="nx">facetView</span> <span class="o">==</span> <span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">facetView</span><span class="p">.</span><span class="nx">resize</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Handles keydown events on the document. Used to complete the Cmd+A deletion, and
blurring focus.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_maybeDisableFacets</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span> <span class="o">&amp;&amp;</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">hotkeys</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;backspace&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clearSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">allSelected</span> <span class="o">&amp;&amp;</span> <span class="nx">VS</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">hotkeys</span><span class="p">.</span><span class="nx">printable</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clearSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h1>Focusing Facets</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Move focus between facets and inputs. Takes a direction as well as many options
for skipping over inputs and only to facets, placement of cursor position in facet
(i.e. at the end), and selecting the text in the input/facet.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">focusNextFacet</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentView</span><span class="p">,</span> <span class="nx">direction</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">viewCount</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">viewPosition</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">viewPosition</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">viewPosition</span><span class="p">(</span><span class="nx">currentView</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">skipToFacet</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Correct for bouncing between matching text and facet arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span>  <span class="o">&amp;&amp;</span> <span class="nx">direction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">direction</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;facet&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">direction</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">direction</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">skipToFacet</span> <span class="o">&amp;&amp;</span> <span class="nx">currentView</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span> <span class="o">&amp;&amp;</span>
               <span class="nx">viewCount</span> <span class="o">==</span> <span class="nx">viewPosition</span> <span class="o">&amp;&amp;</span> <span class="nx">direction</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Special case of looping around to a facet from the last search input box.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">next</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">viewCount</span><span class="p">,</span> <span class="nx">viewPosition</span> <span class="o">+</span> <span class="nx">direction</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span> <span class="o">&lt;</span> <span class="nx">viewCount</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">[</span><span class="nx">next</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">==</span> <span class="nx">viewCount</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">selectFacet</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;facet&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">selectFacet</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">();</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">setCursorAtEnd</span><span class="p">(</span><span class="nx">direction</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">startAtEnd</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">currentView</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;facet&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">skipToFacet</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&gt;=</span> <span class="nx">viewCount</span> <span class="o">||</span> <span class="nx">next</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">view</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">);</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">[</span><span class="nx">next</span><span class="p">];</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">();</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">setCursorAtEnd</span><span class="p">(</span><span class="nx">direction</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">startAtEnd</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="nx">next</span><span class="p">];</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">selectText</span><span class="p">)</span> <span class="nx">view</span><span class="p">.</span><span class="nx">selectText</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resizeFacets</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">maybeFocusSearch</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;.VS-search-box&#39;</span><span class="p">)</span> <span class="o">||</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;.VS-search-inner&#39;</span><span class="p">)</span> <span class="o">||</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;keydown&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">focusSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Bring focus to last input field.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">focusSearch</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">selectText</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">(</span><span class="nx">selectText</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">selectText</span><span class="p">)</span> <span class="nx">view</span><span class="p">.</span><span class="nx">setCursorAtEnd</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;keydown&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">keydown</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">box</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input:focus&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">enableEdit</span><span class="p">(</span><span class="nx">selectText</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Double-clicking on the search wrapper should select the existing text in
the last search input. Also start the triple-click timer.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">highlightSearch</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;.VS-search-box&#39;</span><span class="p">)</span> <span class="o">||</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;.VS-search-inner&#39;</span><span class="p">)</span> <span class="o">||</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;keydown&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lastinput</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">lastinput</span><span class="p">.</span><span class="nx">startTripleClickTimer</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">focusSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">maybeTripleClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lastinput</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">lastinput</span><span class="p">.</span><span class="nx">maybeTripleClick</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Used to show the user is focused on some input inside the search box.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">addFocus</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-search-box&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;VS-focus&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>User is no longer focused on anything in the search box.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">removeFocus</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">focus</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetViews</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inputViews</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">isFocused</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">focus</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-search-box&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;VS-focus&#39;</span><span class="p">);</span>
  <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Show a menu which adds pre-defined facets to the search box. This is unused for now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">showFacetCategoryMenu</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetCategoryMenu</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetCategoryMenu</span><span class="p">.</span><span class="nx">modes</span><span class="p">.</span><span class="nx">open</span> <span class="o">==</span> <span class="s1">&#39;is&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetCategoryMenu</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Account&#39;</span><span class="p">,</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addFacet</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;account&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)},</span>
      <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Project&#39;</span><span class="p">,</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addFacet</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)},</span>
      <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Filter&#39;</span><span class="p">,</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addFacet</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)},</span>
      <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Access&#39;</span><span class="p">,</span> <span class="nx">onClick</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addFacet</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
    <span class="p">];</span>

    <span class="kd">var</span> <span class="nx">menu</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">facetCategoryMenu</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">facetCategoryMenu</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">dc</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">Menu</span><span class="p">({</span>
      <span class="nx">items</span>       <span class="o">:</span> <span class="nx">items</span><span class="p">,</span>
      <span class="nx">standalone</span>  <span class="o">:</span> <span class="kc">true</span>
    <span class="p">}));</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.VS-icon-search&#39;</span><span class="p">).</span><span class="nx">after</span><span class="p">(</span><span class="nx">menu</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">open</span><span class="p">().</span><span class="nx">content</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">});</span>

<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 